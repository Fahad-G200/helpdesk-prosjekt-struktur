{% extends "base.html" %}
{% block content %}
<style>
  .chatbot-container {
    display: flex;
    flex-direction: column;
    height: 600px;
    border-radius: 16px;
    border: 1px solid rgba(148, 163, 184, 0.14);
    background: rgba(15, 23, 42, 0.85);
    overflow: hidden;
  }

  .chatbot-header {
    padding: 16px;
    background: linear-gradient(180deg, rgba(2, 132, 199, 0.22) 0%, rgba(2, 132, 199, 0.1) 100%);
    border-bottom: 1px solid rgba(148, 163, 184, 0.14);
    font-weight: 900;
    color: #38bdf8;
  }

  .chatbot-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .chat-message {
    padding: 10px 12px;
    border-radius: 12px;
    max-width: 85%;
    word-wrap: break-word;
  }

  .chat-message.user {
    align-self: flex-end;
    background: rgba(2, 132, 199, 0.25);
    border: 1px solid rgba(2, 132, 199, 0.35);
    color: #e2e8f0;
  }

  .chat-message.bot {
    align-self: flex-start;
    background: rgba(100, 116, 139, 0.15);
    border: 1px solid rgba(148, 163, 184, 0.18);
    color: #cbd5e1;
  }

  .chatbot-input-area {
    padding: 12px;
    border-top: 1px solid rgba(148, 163, 184, 0.14);
    display: flex;
    gap: 8px;
  }

  .chatbot-input-area input {
    flex: 1;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.18);
    background: rgba(2, 6, 23, 0.35);
    color: #e5e7eb;
    font-size: 14px;
    outline: none;
  }

  .chatbot-input-area input:focus {
    border-color: rgba(56, 189, 248, 0.55);
    box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.18);
  }

  .chatbot-input-area button {
    background: var(--primary, #0284c7);
    color: white;
    border: 0;
    border-radius: 12px;
    padding: 10px 14px;
    font-weight: 900;
    cursor: pointer;
  }

  .chatbot-input-area button:hover {
    background: var(--primaryHover, #0ea5e9);
  }

  .muted {
    color: #94a3b8;
    font-size: 12px;
  }
</style>

<div class="card">
  <h1>Chatbot</h1>
  <p class="muted">Spørsmål og hjelp fra vår AI-assistent</p>
</div>

<div class="card" style="padding: 0;">
  <div class="chatbot-container">
    <div class="chatbot-header">
      AI Helpdesk Assistant
    </div>

    <div class="chatbot-messages" id="chatMessages">
      <div class="chat-message bot">
        Hei! Jeg er her for å hjelpe deg med spørsmål om Feide, Wi-Fi, utskrift, passord og mer. Hva kan jeg hjelpe med?
      </div>
    </div>

    <div class="chatbot-input-area">
      <input 
        type="text" 
        id="chatInput" 
        placeholder="Skriv ditt spørsmål her…"
        autocomplete="off"
      />
      <button id="chatSend" type="button">Send</button>
    </div>
  </div>
</div>

<script>
(function() {
  const messagesEl = document.getElementById("chatMessages");
  const inputEl = document.getElementById("chatInput");
  const sendEl = document.getElementById("chatSend");

  function addMessage(isUser, text) {
    const div = document.createElement("div");
    div.className = "chat-message " + (isUser ? "user" : "bot");
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function sendMessage() {
    const msg = (inputEl.value || "").trim();
    if (!msg) return;

    addMessage(true, msg);
    inputEl.value = "";
    inputEl.focus();

    try {
      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ message: msg }),
      });

      const ct = (res.headers.get("content-type") || "").toLowerCase();
      if (!ct.includes("application/json")) {
        addMessage(false, "Du ser ut til å være logget ut. Last siden på nytt og logg inn igjen.");
        return;
      }

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        addMessage(false, data.reply || "Noe gikk galt. Prøv igjen.");
        return;
      }

      addMessage(false, data.reply || "Ingen svar.");
    } catch (e) {
      addMessage(false, "Kunne ikke kontakte serveren. Er du pålogget?");
    }
  }

  sendEl.addEventListener("click", sendMessage);
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendMessage();
    }
  });
})();
</script>
{% endblock %}
