<!doctype html>
<html lang="no">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Helpdesk</title>

    <style>
      :root{
        --bg:#f4f6f8; --text:#222; --muted:#666;
        --card:#fff; --border:#e5e7eb;
        --primary:#2563eb; --primaryHover:#1d4ed8;
        --green:#16a34a; --yellow:#ca8a04; --red:#dc2626;
        --gray:#475569; --grayHover:#334155;
      }

      body{
        font-family: Arial, sans-serif;
        font-size:16px;
        max-width:980px;
        margin:40px auto;
        padding:0 16px;
        background:var(--bg);
        color:var(--text);
      }

      header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:18px;
      }

      nav{
        display:flex;
        gap:12px;
        align-items:center;
        flex-wrap:wrap;
      }

      .pill{
        background:#eef2ff;
        border:1px solid #dbeafe;
        color:#1e3a8a;
        padding:6px 10px;
        border-radius:999px;
        font-size:.9rem;
        white-space:nowrap;
      }

      /* ===== MENYKNAPPER (TOPP) ===== */
      .nav-btn{
        display:inline-block;
        padding:10px 14px;
        border-radius:10px;
        font-weight:800;
        text-decoration:none;
        color:#fff;
        background:var(--gray);
      }

      .nav-btn:hover{
        background:var(--grayHover);
      }

      .nav-btn.active{
        background:var(--primary);
      }

      .nav-btn.active:hover{
        background:var(--primaryHover);
      }

      /* ===== BLÅ BOKS-LENKER I INNHOLD ===== */
      .link-box{
        display:inline-block;
        padding:10px 14px;
        border-radius:10px;
        font-weight:800;
        text-decoration:none;
        background:var(--primary);
        color:#fff;
        margin-right:10px;
      }

      .link-box:hover{
        background:var(--primaryHover);
      }

      .card{
        background:var(--card);
        border:1px solid var(--border);
        border-radius:12px;
        padding:16px;
        margin:14px 0;
        box-shadow:0 2px 6px rgba(0,0,0,.05);
      }

      .muted{ color:var(--muted); }

      input, textarea, select{
        width:100%;
        padding:12px;
        margin:8px 0 14px;
        border-radius:10px;
        border:1px solid #cfd6df;
        font-size:16px;
        box-sizing:border-box;
      }

      button{
        background:var(--primary);
        color:#fff;
        border:0;
        border-radius:10px;
        padding:10px 14px;
        font-weight:800;
        cursor:pointer;
      }

      button:hover{
        background:var(--primaryHover);
      }

      .flash{
        border-left:6px solid var(--green);
      }

      .error{
        background:#fee2e2;
        border:1px solid #fecaca;
        color:#7f1d1d;
        padding:12px;
        border-radius:10px;
        margin:12px 0;
        font-weight:700;
      }

      .badge{
        background:#dc2626;
        color:#fff;
        padding:2px 6px;
        border-radius:12px;
        font-size:.85em;
        margin-left:4px;
      }
    </style>
  </head>

  <body>
    <header>
      <strong>Helpdesk</strong>

      <nav>
        {% if session.get("user") %}
          <span class="pill">
            Innlogget: {{ session.get("user") }} ({{ session.get("role") }})
          </span>

          {% set ep = request.endpoint or "" %}

          <a href="{{ url_for('main.kb') }}"
             class="nav-btn {% if ep == 'main.kb' %}active{% endif %}">
            Kunnskapsbase
          </a>

          <a href="{{ url_for('main.tickets') }}"
             class="nav-btn {% if ep == 'main.tickets' %}active{% endif %}">
            Mine saker
          </a>

          <a href="{{ url_for('main.notifications_page') }}"
             class="nav-btn {% if ep == 'main.notifications_page' %}active{% endif %}">
            Varsler
            {% if notif_count and notif_count > 0 %}
              <span class="badge">{{ notif_count }}</span>
            {% endif %}
          </a>

          <a href="{{ url_for('main.settings') }}"
             class="nav-btn {% if ep == 'main.settings' %}active{% endif %}">
            Innstillinger
          </a>

          <a href="{{ url_for('main.logout') }}" class="nav-btn">
            Logg ut
          </a>
        {% endif %}
      </nav>
    </header>

    {% with messages = get_flashed_messages() %}
      {% for m in messages %}
        <div class="card flash">{{ m }}</div>
      {% endfor %}
    {% endwith %}

    {% block content %}{% endblock %}

    <!-- CHATBOT -->
    <div id="chatbot" style="position:fixed; right:18px; bottom:18px; width:320px; z-index:9999;">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>Helpdesk-chat</strong>
          <button id="chatToggle" type="button">Skjul</button>
        </div>

        <div id="chatBody">
          <div id="chatLog"
               style="height:180px; overflow:auto; border:1px solid #e5e7eb;
                      border-radius:10px; padding:10px; margin-top:10px;">
            <div class="muted">
              Hei! Skriv hva du trenger hjelp med (Feide, Wi-Fi, utskrift, passord).
            </div>
          </div>

          <div style="display:flex; gap:8px; margin-top:10px;">
            <input id="chatInput" type="text" placeholder="Skriv her…" />
            <button id="chatSend" type="button">Send</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const body = document.getElementById("chatBody");
        const btn  = document.getElementById("chatToggle");

        // Toggle vis/skjul
        btn.addEventListener("click", () => {
          const hidden = body.style.display === "none";
          body.style.display = hidden ? "block" : "none";
          btn.textContent = hidden ? "Skjul" : "Vis";
        });

        // Send chat
        const logEl = document.getElementById("chatLog");
        const inputEl = document.getElementById("chatInput");
        const sendEl = document.getElementById("chatSend");

        function addMsg(who, text) {
          const wrap = document.createElement("div");
          wrap.style.margin = "8px 0";
          wrap.innerHTML = `<strong>${who}:</strong> <span style="white-space:pre-wrap;"></span>`;
          wrap.querySelector("span").textContent = text;
          logEl.appendChild(wrap);
          logEl.scrollTop = logEl.scrollHeight;
        }

        async function sendMsg() {
          const msg = (inputEl.value || "").trim();
          if (!msg) return;

          addMsg("Du", msg);
          inputEl.value = "";
          inputEl.focus();

          try {
            const res = await fetch("/chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message: msg }),
            });

            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
              addMsg("Bot", data.reply || "Noe gikk galt. Prøv igjen.");
              return;
            }

            addMsg("Bot", data.reply || "Ingen svar.");
          } catch (e) {
            addMsg("Bot", "Kunne ikke kontakte serveren. Er du pålogget og kjører appen?");
          }
        }

        sendEl.addEventListener("click", sendMsg);
        inputEl.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            sendMsg();
          }
        });
      })();
    </script>
  </body>
</html>